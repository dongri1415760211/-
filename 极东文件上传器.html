<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æä¸œæ–‡ä»¶ä¸Šä¼ å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #333; }
        h1 { font-size: 2rem; margin-bottom: 10px; }
        .desc { color: #ccc; margin-bottom: 30px; line-height: 1.6; }
        .upload-area { 
            border: 3px dashed #444; 
            border-radius: 10px; 
            padding: 40px 20px; 
            text-align: center; 
            margin-bottom: 25px;
            background: rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }
        .upload-area:hover { border-color: #666; }
        .upload-area.dragover { 
            border-color: #4CAF50; 
            background: rgba(76,175,80,0.1);
            transform: scale(1.02);
        }
        .file-input { display: none; }
        .upload-btn { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer;
            margin-top: 15px;
            font-size: 1.1rem;
        }
        .upload-btn:disabled { background: #666; cursor: not-allowed; }
        .upload-btn-select {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 15px;
        }
        .progress-section { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; }
        .progress { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        .progress-info { display: flex; justify-content: space-between; margin-top: 10px; color: #888; }
        .status { margin: 15px 0; text-align: center; padding: 10px; border-radius: 5px; }
        .status.processing { background: rgba(255,165,0,0.1); color: #FFA500; }
        .status.success { background: rgba(76,175,80,0.1); color: #4CAF50; }
        .status.error { background: rgba(244,67,54,0.1); color: #F44336; }
        .result-section { display: none; margin-top: 30px; }
        .result-box { 
            background: #111; 
            border: 1px solid #333; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0;
            position: relative;
        }
        .code-text { 
            color: #4CAF50; 
            font-family: monospace; 
            word-break: break-all; 
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
        }
        .copy-btn { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background: #2196F3; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .copy-btn:hover { background: #1976D2; }
        .action-btns { display: flex; gap: 15px; margin-top: 20px; }
        .action-btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 1rem;
        }
        .new-btn { background: #666; color: white; }
        .file-info {
            margin-top: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 15px;
        }
        .file-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .file-info-label { color: #ccc; }
        .file-info-value { color: #4CAF50; }
        footer { 
            text-align: center; 
            margin-top: 50px; 
            padding-top: 20px; 
            border-top: 1px solid #333; 
            color: #666; 
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æä¸œæ–‡ä»¶ä¸Šä¼ å™¨</h1>
            <div class="desc">è¶…å¤§æ–‡ä»¶éšæ„ä¼ ï¼æ°¸ä¹…å…è´¹ä¸è¦é’±ï¼</div>
        </header>
        
        <main>
            <div class="upload-area" id="uploadArea">
                <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                <div style="font-size: 1.2rem; margin-bottom: 10px;">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                <div style="color: #888; margin-bottom: 20px;">æ”¯æŒä»»æ„æ ¼å¼æ–‡ä»¶ï¼Œæ–‡ä»¶å°†è‡ªåŠ¨åˆ‡å‰²æˆ50MBä»¥ä¸‹çš„å°å—å¹¶ä¸Šä¼ </div>
                <input type="file" id="fileInput" class="file-input" accept="*/*">
                <button class="upload-btn-select" id="selectBtn">é€‰æ‹©æ–‡ä»¶</button>
                <div id="fileInfo" class="file-info" style="display: none;">
                    <div class="file-info-item">
                        <span class="file-info-label">æ–‡ä»¶å:</span>
                        <span class="file-info-value" id="fileNameDisplay"></span>
                    </div>
                    <div class="file-info-item">
                        <span class="file-info-label">æ–‡ä»¶å¤§å°:</span>
                        <span class="file-info-value" id="fileSizeDisplay"></span>
                    </div>
                </div>
                <button class="upload-btn" id="uploadBtn" disabled>å¼€å§‹ä¸Šä¼ </button>
            </div>
            
            <div class="progress-section" id="progressSection">
                <div class="progress-info">
                    <span id="actionText">æ­£åœ¨å‡†å¤‡...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="progress-info">
                    <span id="chunkText">ç‰‡æ®µ: 0/0</span>
                    <span id="sizeText">å¤§å°: 0 MB</span>
                </div>
                <div class="status processing" id="statusText">å‡†å¤‡å¼€å§‹å¤„ç†...</div>
            </div>
            
            <div class="result-section" id="resultSection">
                <h2>ä¸Šä¼ å®Œæˆ</h2>
                <div class="result-box">
                    <div class="code-text" id="codeOutput">æ­£åœ¨ç”Ÿæˆä»£ç ...</div>
                    <button class="copy-btn" id="copyBtn">å¤åˆ¶ä»£ç </button>
                </div>
                <div style="color: #888; margin: 10px 0; font-size: 0.9rem;">
                    è¯·å¤åˆ¶ä¸Šæ–¹ä»£ç ï¼Œç„¶åå‰å¾€ä¸‹è½½é¡µé¢ç²˜è´´ä¸‹è½½
                </div>
                <div class="action-btns">
                    <button class="action-btn new-btn" id="newBtn">å¤„ç†æ–°æ–‡ä»¶</button>
                </div>
            </div>
        </main>
        
        <footer>
            Â© 2024 æ¥µæ±ã‚¹ãƒ¼ãƒ‘ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ - ç„¡æ–­è¤‡å†™ãƒ»è»¢è¼‰ã‚’ç¦ã˜ã¾ã™
        </footer>
    </div>

    <script>
        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressSection = document.getElementById('progressSection');
        const actionText = document.getElementById('actionText');
        const percentText = document.getElementById('percentText');
        const progressBar = document.getElementById('progressBar');
        const chunkText = document.getElementById('chunkText');
        const sizeText = document.getElementById('sizeText');
        const statusText = document.getElementById('statusText');
        const resultSection = document.getElementById('resultSection');
        const codeOutput = document.getElementById('codeOutput');
        const copyBtn = document.getElementById('copyBtn');
        const newBtn = document.getElementById('newBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const fileSizeDisplay = document.getElementById('fileSizeDisplay');
        
        // é…ç½®
        const API_URL = 'https://wcsprodh5.qlbig05.xyz/v1/assets/upload-v4';
        const TOKEN = 'CAoQARjd7UwgBSiY6IPrsTM.jEFfFdUvqpGdwWwLwIYHtugFDL3qWWneCP9S9pW2p1jOLdQOhijg5iOiKSZfAZjxfGu5h17k6uTCzhu8YobEBw';
        const CHUNK_SIZE = 50 * 1024 * 1024; // 50MB
        
        let currentFile = null;
        let uploadedUrls = [];
        
        // äº‹ä»¶ç›‘å¬
        selectBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('click', (e) => {
            if (e.target === selectBtn || e.target === uploadBtn) return;
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                currentFile = e.target.files[0];
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                fileNameDisplay.textContent = currentFile.name;
                fileSizeDisplay.textContent = formatFileSize(currentFile.size);
                fileInfo.style.display = 'block';
                
                uploadBtn.disabled = false;
                uploadBtn.textContent = `ä¸Šä¼  ${formatFileSize(currentFile.size)} çš„æ–‡ä»¶`;
            }
        });
        
        uploadBtn.addEventListener('click', () => {
            if (currentFile) {
                startUpload();
            }
        });
        
        copyBtn.addEventListener('click', copyCode);
        newBtn.addEventListener('click', resetUploader);
        
        // æ‹–æ‹½äº‹ä»¶ç›‘å¬
        uploadArea.addEventListener('dragenter', handleDragEnter);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        
        // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });
        
        // æ‹–æ‹½å¤„ç†å‡½æ•°
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight(e) {
            uploadArea.classList.add('dragover');
        }
        
        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }
        
        function handleDragEnter(e) {
            preventDefaults(e);
            highlight(e);
        }
        
        function handleDragOver(e) {
            preventDefaults(e);
            highlight(e);
        }
        
        function handleDragLeave(e) {
            preventDefaults(e);
            if (e.target === uploadArea) {
                unhighlight(e);
            }
        }
        
        function handleDrop(e) {
            preventDefaults(e);
            unhighlight(e);
            
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            // åªå–ç¬¬ä¸€ä¸ªæ–‡ä»¶
            const file = files[0];
            
            currentFile = file;
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileNameDisplay.textContent = file.name;
            fileSizeDisplay.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            uploadBtn.disabled = false;
            uploadBtn.textContent = `ä¸Šä¼  ${formatFileSize(file.size)} çš„æ–‡ä»¶`;
        }
        
        // å¼€å§‹ä¸Šä¼ å¤„ç†
        async function startUpload() {
            if (!currentFile) return;
            
            uploadArea.style.display = 'none';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            
            uploadedUrls = [];
            const totalChunks = Math.ceil(currentFile.size / CHUNK_SIZE);
            
            try {
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, currentFile.size);
                    const chunk = currentFile.slice(start, end);
                    
                    // æ›´æ–°è¿›åº¦
                    updateProgress(i, totalChunks, 'åˆ‡å‰²ä¸­');
                    
                    // åˆ›å»ºæ–‡ä»¶å¯¹è±¡ï¼Œå¼ºåˆ¶æ”¹ä¸º.mp4æ‰©å±•å
                    const chunkBlob = new Blob([chunk], { type: 'application/octet-stream' });
                    const chunkFile = new File([chunkBlob], `chunk_${i}.mp4`, { type: 'video/mp4' });
                    
                    // ä¸Šä¼ åˆ†ç‰‡
                    const url = await uploadChunk(chunkFile, i + 1, totalChunks);
                    if (url) {
                        uploadedUrls.push(url);
                        updateProgress(i + 1, totalChunks, 'ä¸Šä¼ ä¸­');
                    } else {
                        throw new Error(`ç¬¬ ${i + 1} ä¸ªåˆ†ç‰‡ä¸Šä¼ å¤±è´¥`);
                    }
                }
                
                // æ£€æŸ¥æ‰€æœ‰åˆ†ç‰‡æ˜¯å¦éƒ½ä¸Šä¼ æˆåŠŸ
                if (uploadedUrls.length !== totalChunks) {
                    throw new Error(`åªæœ‰ ${uploadedUrls.length}/${totalChunks} ä¸ªåˆ†ç‰‡ä¸Šä¼ æˆåŠŸ`);
                }
                
                // æ£€æŸ¥URLæ•°ç»„ä¸­æ˜¯å¦æœ‰ç©ºå€¼
                const failedIndex = uploadedUrls.findIndex((url, index) => !url);
                if (failedIndex !== -1) {
                    throw new Error(`ç¬¬ ${failedIndex + 1} ä¸ªåˆ†ç‰‡ä¸Šä¼ å¤±è´¥ï¼ŒURLä¸ºç©º`);
                }
                
                // ä¸Šä¼ å®Œæˆï¼Œç”Ÿæˆä»£ç 
                showSuccess();
                generateCode();
                
            } catch (error) {
                showError(error.message);
            }
        }
        
        // ä¸Šä¼ å•ä¸ªåˆ†ç‰‡
        function uploadChunk(chunkFile, chunkNumber, totalChunks) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('myFile', chunkFile);
                formData.append('type', '4'); // è§†é¢‘ç±»å‹
                
                const xhr = new XMLHttpRequest();
                const traceId = generateTraceId();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        const overallPercent = Math.round(((chunkNumber - 1 + (percent / 100)) / totalChunks) * 100);
                        progressBar.style.width = `${overallPercent}%`;
                        percentText.textContent = `${overallPercent}%`;
                    }
                });
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (xhr.status === 200 && response.code === 200) {
                            const fileUrl = parseFileUrl(response.data);
                            if (fileUrl) {
                                resolve(fileUrl);
                            } else {
                                reject(new Error('æ— æ³•è§£ææ–‡ä»¶URL'));
                            }
                        } else if (xhr.status === 202 && response.code === 200) {
                            // å¼‚æ­¥å¤„ç†
                            pollUploadResult(response.data, resolve, reject);
                        } else {
                            reject(new Error(response.message || 'ä¸Šä¼ å¤±è´¥'));
                        }
                    } catch (e) {
                        reject(new Error('è§£æå“åº”å¤±è´¥'));
                    }
                };
                
                xhr.onerror = () => reject(new Error('ç½‘ç»œé”™è¯¯'));
                xhr.ontimeout = () => reject(new Error('è¯·æ±‚è¶…æ—¶'));
                
                xhr.open('POST', API_URL);
                xhr.setRequestHeader('x-token', TOKEN);
                xhr.setRequestHeader('x-trace-id', traceId);
                xhr.setRequestHeader('Accept', '*/*');
                xhr.timeout = 60000;
                xhr.send(formData);
            });
        }
        
        // è§£ææ–‡ä»¶URL
        function parseFileUrl(data) {
            const baseUrl = 'https://imagesacc.qlbig05.xyz';
            
            if (typeof data === 'string' && data.startsWith('/')) {
                return baseUrl + data;
            }
            
            if (data && typeof data === 'object') {
                if (data.uri && data.uri.startsWith('/')) {
                    return baseUrl + data.uri;
                }
                if (data.filepath && data.filepath.startsWith('/')) {
                    return baseUrl + data.filepath;
                }
                if (data.url && data.url.startsWith('/')) {
                    return baseUrl + data.url;
                }
                
                // å°è¯•æŸ¥æ‰¾ä»»ä½•ä»¥/å¼€å¤´çš„å­—ç¬¦ä¸²
                for (const key in data) {
                    if (typeof data[key] === 'string' && data[key].startsWith('/')) {
                        return baseUrl + data[key];
                    }
                }
            }
            
            return null;
        }
        
        // è½®è¯¢ä¸Šä¼ ç»“æœ
        function pollUploadResult(uploadId, resolve, reject) {
            const eventSource = new EventSource(`${API_URL}?uploadId=${uploadId}`);
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.percentage === 100 && data.data) {
                        eventSource.close();
                        const fileUrl = parseFileUrl(data.data);
                        if (fileUrl) {
                            resolve(fileUrl);
                        } else {
                            reject(new Error('æ— æ³•è§£æè½®è¯¢ç»“æœ'));
                        }
                    }
                } catch (e) {
                    console.error('è§£æè½®è¯¢æ•°æ®å¤±è´¥:', e);
                }
            };
            
            eventSource.onerror = function() {
                eventSource.close();
                reject(new Error('è½®è¯¢è¿æ¥å¤±è´¥'));
            };
            
            setTimeout(() => {
                eventSource.close();
                reject(new Error('è½®è¯¢è¶…æ—¶'));
            }, 300000);
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total, action) {
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = `${percent}%`;
            percentText.textContent = `${percent}%`;
            actionText.textContent = action;
            chunkText.textContent = `ç‰‡æ®µ: ${current}/${total}`;
            sizeText.textContent = `å¤§å°: ${formatFileSize(current * CHUNK_SIZE)}`;
            statusText.textContent = `${action}: ${current}/${total}`;
        }
        
        // æ˜¾ç¤ºæˆåŠŸ
        function showSuccess() {
            progressBar.style.width = '100%';
            percentText.textContent = '100%';
            actionText.textContent = 'å®Œæˆ';
            statusText.textContent = 'æ‰€æœ‰ç‰‡æ®µä¸Šä¼ æˆåŠŸï¼';
            statusText.className = 'status success';
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            statusText.textContent = `é”™è¯¯: ${message}`;
            statusText.className = 'status error';
            
            // æ·»åŠ æ‰‹åŠ¨è¿”å›æŒ‰é’®
            if (!document.getElementById('backToUploadBtn')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'backToUploadBtn';
                backBtn.textContent = 'è¿”å›ä¸»é¡µ';
                backBtn.className = 'upload-btn';
                backBtn.style.marginTop = '20px';
                backBtn.onclick = () => {
                    progressSection.style.display = 'none';
                    uploadArea.style.display = 'block';
                    backBtn.remove();
                };
                statusText.parentNode.appendChild(backBtn);
            }
        }
        
        // ç”Ÿæˆä¸‹è½½ä»£ç 
        function generateCode() {
            if (uploadedUrls.length === 0) return;
            
            const data = {
                n: currentFile.name,        // ç¼©çŸ­å­—æ®µå
                t: currentFile.type,
                s: currentFile.size,
                u: uploadedUrls,
                c: uploadedUrls.length,
                ts: Date.now()
            };
            
            // ä½¿ç”¨æ›´é«˜æ•ˆçš„å‹ç¼©ç¼–ç 
            const jsonStr = JSON.stringify(data);
            const compressedStr = compressString(jsonStr);
            
            codeOutput.textContent = compressedStr;
            
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
        }
        
        // å¤åˆ¶ä»£ç 
        function copyCode() {
            const code = codeOutput.textContent;
            if (!code) return;
            
            navigator.clipboard.writeText(code).then(() => {
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.style.background = '#4CAF50';
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶ä»£ç ';
                    copyBtn.style.background = '#2196F3';
                }, 2000);
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                copyBtn.textContent = 'å·²å¤åˆ¶';
                copyBtn.style.background = '#4CAF50';
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶ä»£ç ';
                    copyBtn.style.background = '#2196F3';
                }, 2000);
            });
        }
        
        // é‡ç½®ä¸Šä¼ å™¨
        function resetUploader() {
            currentFile = null;
            uploadedUrls = [];
            fileInput.value = '';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'å¼€å§‹ä¸Šä¼ ';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            progressSection.style.display = 'none';
            resultSection.style.display = 'none';
            progressBar.style.width = '0%';
            percentText.textContent = '0%';
            statusText.className = 'status processing';
            
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„è¿”å›æŒ‰é’®
            const backBtn = document.getElementById('backToUploadBtn');
            if (backBtn) {
                backBtn.remove();
            }
        }
        
        // é«˜æ•ˆå­—ç¬¦ä¸²å‹ç¼©å‡½æ•°
        function compressString(str) {
            // å­—ç¬¦æ›¿æ¢å‹ç¼©
            let compressed = str;
            
            // å¸¸è§å­—ç¬¦ä¸²æ›¿æ¢æ˜ å°„ - é¡ºåºå¾ˆé‡è¦ï¼
            const replacements = [
                {from: 'https://imagesacc.qlbig05.xyz', to: 'A'},
                {from: '"filename":', to: 'n:'},
                {from: '"filetype":', to: 't:'},
                {from: '"filesize":', to: 's:'},
                {from: '"urls":', to: 'u:'},
                {from: '"chunkCount":', to: 'c:'},
                {from: '"timestamp":', to: 'ts:'},
                {from: '":"', to: ','}, // JSONé€—å·å’Œå†’å·
                {from: '":', to: ':'}, // JSONå†’å·
                {from: '"', to: ''}   // æœ€åç§»é™¤å¼•å·
            ];
            
            replacements.forEach(replacement => {
                compressed = compressed.split(replacement.from).join(replacement.to);
            });
            
            // å®‰å…¨çš„Base64ç¼–ç 
            return btoaSafe(compressed).replace(/=/g, '');
        }
        
        // å®‰å…¨çš„Base64ç¼–ç å‡½æ•°ï¼Œæ”¯æŒUnicodeå­—ç¬¦
        function btoaSafe(str) {
            try {
                return btoa(str);
            } catch (e) {
                // æ­£ç¡®å¤„ç†Unicodeå­—ç¬¦
                const utf8Bytes = new TextEncoder().encode(str);
                let binary = '';
                for (let i = 0; i < utf8Bytes.length; i++) {
                    binary += String.fromCharCode(utf8Bytes[i]);
                }
                return btoa(binary);
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function generateTraceId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // åˆå§‹åŒ–
        function init() {
            // ç§»é™¤localStorageç›¸å…³ä»£ç ï¼Œé¡µé¢å®Œå…¨ç‹¬ç«‹
        }
        
        init();
    </script>
</body>
</html>
